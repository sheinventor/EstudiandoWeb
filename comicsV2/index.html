<!DOCTYPE html>
<html lang="es">
  <!-- Establece el lenguaje del documento HTML a espa√±ol -->
<head>
  <meta charset="UTF-8" />
  <!-- Define que el juego de caracteres es UTF-8 (soporta todos los caracteres especiales) -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Establece c√≥mo debe comportarse la p√°gina en dispositivos m√≥viles (ajuste del tama√±o seg√∫n el dispositivo) -->
  <title>Visor de C√≥mics</title>
  <!-- Define el t√≠tulo de la p√°gina que aparece en la pesta√±a del navegador -->
  <style>
    /* Aqu√≠ se define el estilo CSS de la p√°gina */
    body {
      font-family: sans-serif;
      background: #fff;
      text-align: center;
      margin: 0;
    }
    /* El contenedor de la imagen del c√≥mic se ajustar√° en la p√°gina */
    #comic-container {
      position: relative;
      max-width: 600px;
      margin: auto;
    }
    #comic-img {
      width: 100%;
      height: auto;
    }
    .text-overlay {
      position: absolute;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }
    /* Estilo de los botones y miniaturas */
    .controls, .recent-comics {
      margin: 20px;
    }
    .recent-comic {
      width: 80px;
      cursor: pointer;
      margin: 5px;
    }
    button {
      padding: 10px;
      margin: 5px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <!-- Encabezado con el t√≠tulo de la p√°gina -->
  <h1>Visor de C√≥mics</h1>
  <!-- Selector de c√≥mics que se llenar√° din√°micamente con las opciones de c√≥mics -->
  <select id="comic-selector"></select>
  
  <!-- Selector para elegir el idioma -->
  <select id="language">
    <option value="es">Espa√±ol</option>
    <option value="en">English</option>
    <option value="fr">Fran√ßais</option>
  </select>
  
  <!-- Contenedor donde se mostrar√° la imagen del c√≥mic -->
  <div id="comic-container">
    <img id="comic-img" src="" alt="Comic">
  </div>

  <!-- Botones para navegar entre las p√°ginas del c√≥mic -->
  <div class="controls">
    <button onclick="previousPage()">‚óÄÔ∏è</button>
    <button onclick="goHome()">üîÅ</button>
    <button onclick="nextPage()">‚ñ∂Ô∏è</button>
  </div>

  <!-- Contenedor donde se mostrar√°n las miniaturas de c√≥mics recientes -->
  <div class="recent-comics" id="recent-comics"></div>
  
  <!-- Contenedor para el reproductor de Spotify (si aplica) -->
  <div id="spotify-container"></div>

  <script>
    /* Declaraci√≥n de variables para el control del c√≥mic actual */
    let currentPage = 0;
    let totalPages = 0;
    let comicName = "comic1";  // C√≥mic inicial
    let language = "es";  // Idioma inicial
    let manifest = null;  // Manifiesto que contiene datos sobre el c√≥mic

    /* Cambia el idioma al seleccionar una opci√≥n */
    document.getElementById("language").addEventListener("change", function () {
      language = this.value;  // Actualiza el idioma seleccionado
      loadText();  // Recarga los subt√≠tulos con el nuevo idioma
    });

    /* Carga el manifiesto del c√≥mic (informaci√≥n sobre las p√°ginas y subt√≠tulos) */
    function loadManifest(callback) {
      fetch(`comics/${comicName}/manifest.json`)
        .then(res => res.json())  // Lee el archivo JSON del manifiesto
        .then(data => {
          manifest = data;  // Guarda los datos del manifiesto
          totalPages = data.pages;  // Define el n√∫mero total de p√°ginas
          callback();  // Llama a la funci√≥n que maneja la carga del c√≥mic
        });
    }

    /* Carga la imagen y los subt√≠tulos del c√≥mic */
    function loadComic() {
      document.getElementById("comic-img").src = `comics/${comicName}/${currentPage}.jpg`;  // Cambia la imagen del c√≥mic
      loadText();  // Carga los subt√≠tulos correspondientes a la p√°gina
    }

    /* Carga los subt√≠tulos y los muestra sobre la imagen */
    function loadText() {
      document.querySelectorAll('.text-overlay').forEach(e => e.remove());  // Elimina los subt√≠tulos anteriores

      let trackSet = false;  // Bandera para controlar la carga de la pista de Spotify

      // Recorre todos los di√°logos del manifiesto
      manifest.dialogs.forEach(d => {
        // Si el di√°logo corresponde a la p√°gina y el idioma seleccionados
        if (d.page === currentPage && d.lang === language) {
          const span = document.createElement("span");  // Crea un nuevo elemento de texto para el subt√≠tulo
          span.className = "text-overlay";  // Asigna estilo al subt√≠tulo
          span.innerText = d.text;  // Asigna el texto del subt√≠tulo
          span.dataset.x = d.x;  // Guarda la posici√≥n X para el subt√≠tulo
          span.dataset.y = d.y;  // Guarda la posici√≥n Y para el subt√≠tulo
          document.getElementById("comic-container").appendChild(span);  // Agrega el subt√≠tulo al contenedor

          // Si existe una pista de Spotify, la carga
          if (d.track && !trackSet) {
            loadSpotify(d.track);  // Carga el iframe de Spotify con la pista
            trackSet = true;  // Marca que ya se carg√≥ la pista
          }
        }
      });

      adjustTextPositions();  // Ajusta la posici√≥n de los subt√≠tulos
    }

    /* Ajusta las posiciones de los subt√≠tulos para que se alineen correctamente con la imagen */
    function adjustTextPositions() {
      const img = document.getElementById("comic-img");
      const width = img.clientWidth;  // Obtiene el ancho de la imagen
      const height = img.clientHeight;  // Obtiene la altura de la imagen

      document.querySelectorAll(".text-overlay").forEach(span => {
        const x = parseFloat(span.dataset.x);  // Obtiene la posici√≥n X del subt√≠tulo
        const y = parseFloat(span.dataset.y);  // Obtiene la posici√≥n Y del subt√≠tulo
        span.style.left = `${(x / 100) * width}px`;  // Calcula la posici√≥n X en p√≠xeles
        span.style.top = `${(y / 100) * height}px`;  // Calcula la posici√≥n Y en p√≠xeles
      });
    }

    /* Navega a la p√°gina anterior del c√≥mic */
    function previousPage() {
      if (currentPage > 0) {
        currentPage--;  // Decrementa la p√°gina
        loadComic();  // Recarga el c√≥mic con la nueva p√°gina
      }
    }

    /* Navega a la siguiente p√°gina del c√≥mic */
    function nextPage() {
      if (currentPage < totalPages - 1) {
        currentPage++;  // Incrementa la p√°gina
        loadComic();  // Recarga el c√≥mic con la nueva p√°gina
      } else {
        alert("¬°Fin del c√≥mic!");  // Muestra un mensaje si ya no hay m√°s p√°ginas
      }
    }

    /* Regresa al inicio del c√≥mic */
    function goHome() {
      currentPage = 0;  // Vuelve a la primera p√°gina
      loadComic();  // Recarga el c√≥mic
    }

    /* Cambia el c√≥mic a uno nuevo */
    function changeComic(name) {
      comicName = name;  // Cambia el nombre del c√≥mic
      currentPage = 0;  // Vuelve a la primera p√°gina
      const select = document.getElementById("comic-selector");
      select.value = comicName;  // Actualiza el valor del selector
      loadManifest(loadComic);  // Recarga el manifiesto del c√≥mic
    }

    /* Carga la lista de c√≥mics disponibles */
    function loadComicList() {
      fetch("comics/index.json")  // Obtiene el archivo JSON con la lista de c√≥mics
        .then(res => res.json())  // Convierte el archivo a formato JSON
        .then(data => {
          const select = document.getElementById("comic-selector");  // Obtiene el selector de c√≥mics
          data.comics.forEach(comic => {
            const option = document.createElement("option");  // Crea una opci√≥n para cada c√≥mic
            option.value = comic.id;
            option.textContent = comic.title;
            select.appendChild(option);  // Agrega la opci√≥n al selector
          });

          select.value = comicName;  // Asegura que el selector tenga el valor correcto
          
          select.addEventListener("change", () => {
            comicName = select.value;  // Actualiza el c√≥mic seleccionado
            currentPage = 0;  // Vuelve a la primera p√°gina
            loadManifest(loadComic);  // Recarga el c√≥mic
          });
        });
    }

    /* Carga las miniaturas de c√≥mics recientes */
    function loadRecentComics() {
      const comics = ["comic1", "comic2", "comic3", "comic4", "comic5"];
      const container = document.getElementById("recent-comics");
      container.innerHTML = "";  // Limpia el contenedor de miniaturas

      comics.forEach(name => {
        const img = document.createElement("img");  // Crea una miniatura
        img.src = `comics/${name}/0.jpg`;  // Asigna la imagen de la miniatura
        img.className = "recent-comic";  // Asigna la clase CSS
        img.onclick = () => {
          changeComic(name);  // Cambia el c√≥mic al hacer clic en la miniatura
        };
        container.appendChild(img);  // Agrega la miniatura al contenedor
      });
    }

    /* Carga una pista de Spotify en el contenedor correspondiente */
    function loadSpotify(trackId) {
      const container = document.getElementById("spotify-container");
      container.innerHTML = `<iframe src="https://open.spotify.com/embed/track/${trackId}" width="300" height="80" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>`;
    }

    /* Ajusta la posici√≥n de los subt√≠tulos cuando la imagen del c√≥mic se carga */
    document.getElementById("comic-img").addEventListener("load", adjustTextPositions);
    
    /* Ajusta la posici√≥n de los subt√≠tulos cuando la ventana se redimensiona */
    window.addEventListener("resize", adjustTextPositions);
    loadComicList();
    loadRecentComics();
    loadManifest(loadComic);
  </script>
</body>
</html>
